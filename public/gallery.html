<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Gallery</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    canvas {
      display: block;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      background: rgba(0,0,0,0.7);
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
      max-width: 300px;
    }
    #info strong {
      font-size: 16px;
      display: block;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div id="info">
  <div id="crosshair" style="position:fixed;left:50%;top:50%;width:32px;height:32px;pointer-events:none;z-index:10;transform:translate(-50%,-50%);">
    <svg width="32" height="32">
      <line x1="16" y1="8" x2="16" y2="24" stroke="#fff" stroke-width="2"/>
      <line x1="8" y1="16" x2="24" y2="16" stroke="#fff" stroke-width="2"/>
    </svg>
  </div>
    <strong>ğŸ¨ 3D ã‚®ãƒ£ãƒ©ãƒªãƒ¼</strong>
    <div style="margin-bottom: 8px;">
      <strong>ğŸ“ æ“ä½œæ–¹æ³•</strong><br>
      â€¢ ã‚¯ãƒªãƒƒã‚¯ã—ã¦å…¥å®¤<br>
      â€¢ ãƒã‚¦ã‚¹ç§»å‹•ã§è¦–ç‚¹å›è»¢
    </div>
    <div style="margin-bottom: 8px;">
      <strong>âŒ¨ï¸ ã‚­ãƒ¼æ“ä½œ</strong><br>
      â€¢ W / â†‘ : å‰é€²<br>
      â€¢ S / â†“ : å¾Œé€€<br>
      â€¢ A / â† : å·¦ç§»å‹•<br>
      â€¢ D / â†’ : å³ç§»å‹•<br>
      â€¢ E / ESC : é€€å®¤
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

    // ã‚·ãƒ¼ãƒ³ã€ã‚«ãƒ¡ãƒ©ã€ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã®åˆæœŸåŒ–
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb); // ç©ºè‰²
    scene.fog = new THREE.Fog(0x87ceeb, 0, 50);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.6, 5); // ç›®ã®é«˜ã•

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);

    // ãƒ©ã‚¤ãƒˆ
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(5, 10, 5);
    directionalLight.castShadow = true;
    directionalLight.shadow.mapSize.width = 2048;
    directionalLight.shadow.mapSize.height = 2048;
    scene.add(directionalLight);

    // åºŠ
    const floorGeometry = new THREE.PlaneGeometry(30, 30);
    const floorMaterial = new THREE.MeshStandardMaterial({ 
      color: 0xcccccc,
      roughness: 0.8,
      metalness: 0.2
    });
    const floor = new THREE.Mesh(floorGeometry, floorMaterial);
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    // å£ã‚’ä½œæˆã™ã‚‹é–¢æ•°
    function createWall(width, height, position, rotation) {
      const wallGeometry = new THREE.BoxGeometry(width, height, 0.2);
      const wallMaterial = new THREE.MeshStandardMaterial({ 
        color: 0xffffff,
        roughness: 0.9
      });
      const wall = new THREE.Mesh(wallGeometry, wallMaterial);
      wall.position.copy(position);
      if (rotation) wall.rotation.y = rotation;
      wall.castShadow = true;
      wall.receiveShadow = true;
      scene.add(wall);
      return wall;
    }

    // 4ã¤ã®å£ã‚’é…ç½®
    createWall(30, 5, new THREE.Vector3(0, 2.5, -15), 0);      // å¥¥
    createWall(30, 5, new THREE.Vector3(0, 2.5, 15), 0);       // æ‰‹å‰
    createWall(30, 5, new THREE.Vector3(-15, 2.5, 0), Math.PI / 2);  // å·¦
    createWall(30, 5, new THREE.Vector3(15, 2.5, 0), Math.PI / 2);   // å³

    // çµµç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹é–¢æ•°
    function createArtwork(imageUrl, position, scale = 1) {
      const group = new THREE.Group();
      // ãƒ•ãƒ¬ãƒ¼ãƒ 
      const frameGeometry = new THREE.BoxGeometry(scale * 2.2, scale * 1.6, 0.1);
      const frameMaterial = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
      const frame = new THREE.Mesh(frameGeometry, frameMaterial);
      group.add(frame);
      // çµµç”»
      const textureLoader = new THREE.TextureLoader();
      const artGeometry = new THREE.PlaneGeometry(scale * 2, scale * 1.5);
      const artMaterial = new THREE.MeshStandardMaterial({ 
        map: textureLoader.load(imageUrl, () => {
          console.log('Loaded:', imageUrl);
        }, undefined, (err) => {
          console.error('Failed to load:', imageUrl, err);
          artMaterial.color.set(0x666666);
        }),
        roughness: 0.8
      });
      const art = new THREE.Mesh(artGeometry, artMaterial);
      art.position.z = 0.06;
      group.add(art);
      group.position.copy(position);
      group.castShadow = true;
      scene.add(group);
      // URLåŸ‹ã‚è¾¼ã¿ç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
  group.userData.url = 'https://www.google.com'; // ã™ã¹ã¦ã®çµµã«åŒã˜URL
  return group;
    }

    // ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ãƒãƒ«ã‚’ä½œæˆã™ã‚‹é–¢æ•°ï¼ˆå£ã«èª¬æ˜æ–‡ã‚’è¡¨ç¤ºï¼‰
    function createTextPanel(text, position, rotation, width = 3, height = 2) {
      const canvas = document.createElement('canvas');
      canvas.width = 1024;
      canvas.height = 768;
      const ctx = canvas.getContext('2d');
      
      // èƒŒæ™¯
      ctx.fillStyle = '#2a2a2a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // æ 
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 20;
      ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
      
      // ãƒ†ã‚­ã‚¹ãƒˆ
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 60px "MS Gothic", monospace';
      ctx.textAlign = 'center';
      ctx.fillText('ğŸ¨ æ“ä½œã‚¬ã‚¤ãƒ‰', canvas.width / 2, 120);
      
      ctx.font = '48px "MS Gothic", monospace';
      ctx.textAlign = 'left';
      const lines = text.split('\n');
      let y = 220;
      lines.forEach(line => {
        ctx.fillText(line, 80, y);
        y += 70;
      });
      
      const texture = new THREE.CanvasTexture(canvas);
      const panelGeometry = new THREE.PlaneGeometry(width, height);
      const panelMaterial = new THREE.MeshStandardMaterial({ 
        map: texture,
        roughness: 0.9
      });
      const panel = new THREE.Mesh(panelGeometry, panelMaterial);
      panel.position.copy(position);
      panel.rotation.y = rotation;
      panel.castShadow = true;
      scene.add(panel);
      
      return panel;
    }

    // ä½œå“ã‚’é…ç½®ï¼ˆã‚µãƒ³ãƒ—ãƒ«ç”»åƒï¼‰
    // å¥¥ã®å£
  createArtwork('https://picsum.photos/400/300?random=1', new THREE.Vector3(-6, 2.5, -14.9), 1);
  createArtwork('https://picsum.photos/400/300?random=2', new THREE.Vector3(0, 2.5, -14.9), 1);
  createArtwork('https://picsum.photos/400/300?random=3', new THREE.Vector3(6, 2.5, -14.9), 1);
    // ãƒã‚¦ã‚¹å·¦ã‚¯ãƒªãƒƒã‚¯ã§æ³¨è¦–ä¸­ã®çµµã«é·ç§» & æ³¨è¦–ä¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    const raycaster = new THREE.Raycaster();
    let lastHovered = null;
    function updateArtworkHighlight() {
      // ã‚«ãƒ¡ãƒ©ä¸­å¤®ã‹ã‚‰Rayã‚’é£›ã°ã™
      raycaster.setFromCamera({x:0, y:0}, camera);
      const clickable = [];
      scene.traverse(obj => {
        if (obj.type === 'Group' && obj.userData.url) clickable.push(obj);
      });
      const intersects = raycaster.intersectObjects(clickable, true);
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
      if (lastHovered && lastHovered.material) {
        // å…ƒã®è‰²ã«æˆ»ã™
        lastHovered.material.emissive && lastHovered.material.emissive.set(0x000000);
        lastHovered = null;
      }
      if (intersects.length > 0) {
        let target = intersects[0].object;
        // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚„çµµç”»æœ¬ä½“ã‚’å–å¾—
        while (target && !target.userData.url && target.parent) target = target.parent;
        if (target && target.children && target.children.length > 1) {
          // çµµç”»æœ¬ä½“ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          const artMesh = target.children[1];
          if (artMesh.material && artMesh.material.emissive) {
            artMesh.material.emissive.set(0x2266ff);
            lastHovered = artMesh;
          }
        }
      }
    }
    renderer.domElement.addEventListener('click', (event) => {
      if (!controls.isLocked) return;
      // ã‚«ãƒ¡ãƒ©ä¸­å¤®ã‹ã‚‰Rayã‚’é£›ã°ã™
      raycaster.setFromCamera({x:0, y:0}, camera);
      const clickable = [];
      scene.traverse(obj => {
        if (obj.type === 'Group' && obj.userData.url) clickable.push(obj);
      });
      const intersects = raycaster.intersectObjects(clickable, true);
      if (intersects.length > 0) {
        let target = intersects[0].object;
        while (target && !target.userData.url && target.parent) target = target.parent;
        if (target && target.userData.url) {
          if (confirm('ã“ã®ä½œå“ã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ\n' + target.userData.url)) {
            window.open(target.userData.url, '_blank');
          }
        }
      }
    });
    // æ—¢å­˜ã®animateé–¢æ•°å†…ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚‚å‘¼ã³å‡ºã™ï¼ˆé‡è¤‡å®šç¾©ã‚’é¿ã‘ã‚‹ï¼‰
    // ã™ã§ã« animate() ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€
    // updateArtworkHighlight() ã‚’æ—¢å­˜ã®animateå†…ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

    // æ‰‹å‰ã®å£ã«æ“ä½œèª¬æ˜ãƒ‘ãƒãƒ«ã‚’é…ç½®
    const guideText = `W / â†‘ : å‰é€²
S / â†“ : å¾Œé€€
A / â† : å·¦ç§»å‹•
D / â†’ : å³ç§»å‹•
E / ESC : é€€å®¤`;
    createTextPanel(guideText, new THREE.Vector3(0, 2.5, 14.85), Math.PI, 4, 3);

    // å·¦ã®å£
    const leftArt1 = createArtwork('https://picsum.photos/400/300?random=4', new THREE.Vector3(-14.9, 2.5, -6), 1);
    leftArt1.rotation.y = Math.PI / 2;
    const leftArt2 = createArtwork('https://picsum.photos/400/300?random=5', new THREE.Vector3(-14.9, 2.5, 6), 1);
    leftArt2.rotation.y = Math.PI / 2;

    // å³ã®å£
    const rightArt1 = createArtwork('https://picsum.photos/400/300?random=6', new THREE.Vector3(14.9, 2.5, -6), 1);
    rightArt1.rotation.y = -Math.PI / 2;
    const rightArt2 = createArtwork('https://picsum.photos/400/300?random=7', new THREE.Vector3(14.9, 2.5, 6), 1);
    rightArt2.rotation.y = -Math.PI / 2;

    // ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãƒ­ãƒƒã‚¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆFPSé¢¨æ“ä½œï¼‰
    const controls = new PointerLockControls(camera, document.body);
    
    // ãƒã‚¦ã‚¹æ„Ÿåº¦ã‚’ä¸‹ã’ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ˆã‚Šé…ãï¼‰
    controls.pointerSpeed = 0.3;

    document.body.addEventListener('click', () => {
      controls.lock();
    });

    controls.addEventListener('lock', () => {
      document.getElementById('info').style.display = 'none';
    });

    controls.addEventListener('unlock', () => {
      document.getElementById('info').style.display = 'block';
    });

    // ç§»å‹•
    const moveSpeed = 0.1;
    const velocity = new THREE.Vector3();
    const direction = new THREE.Vector3();
    const keys = {};

    document.addEventListener('keydown', (e) => {
      keys[e.code] = true;
      
      // E ã‚­ãƒ¼ã§é€€å®¤ï¼ˆãƒã‚¦ã‚¹ãƒ­ãƒƒã‚¯è§£é™¤ï¼‰
      if (e.code === 'KeyE' && controls.isLocked) {
        controls.unlock();
      }
    });

    document.addEventListener('keyup', (e) => {
      keys[e.code] = false;
    });

    function updateMovement() {
      if (!controls.isLocked) return;

      let moveForward = 0;
      let moveRight = 0;

      if (keys['KeyW'] || keys['ArrowUp']) moveForward = 1;     // W = å‰é€²
      if (keys['KeyS'] || keys['ArrowDown']) moveForward = -1;  // S = å¾Œé€€
      if (keys['KeyA'] || keys['ArrowLeft']) moveRight = -1;    // A = å·¦
      if (keys['KeyD'] || keys['ArrowRight']) moveRight = 1;    // D = å³

      // ã‚«ãƒ¡ãƒ©ã®å‘ãã«åŸºã¥ã„ã¦ç§»å‹•ï¼ˆPointerLockControls ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ï¼‰
      controls.moveForward(moveForward * moveSpeed);
      controls.moveRight(moveRight * moveSpeed);

      // ç¯„å›²åˆ¶é™ï¼ˆå£ã®å†…å´ã«ç•™ã‚ã‚‹ï¼‰
      camera.position.x = Math.max(-14, Math.min(14, camera.position.x));
      camera.position.z = Math.max(-14, Math.min(14, camera.position.z));
    }

    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
    function animate() {
      requestAnimationFrame(animate);
      updateMovement();
      renderer.render(scene, camera);
    }

    animate();
  </script>
</body>
</html>
